<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisioBot Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #0d1b2a;
            color: #ffffff;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        

        #chat-container {
            position: relative;
    width: 90%;
    max-width: 800px; /* Adjust max-width as needed */
    margin: 0 auto;
    padding: 20px;
    background-color: #1b263b;
    border-radius: 10px;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.5);
}
/* Make the header a flex container */
#chat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    min-height: 60px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--blue-light);
}

/* Keep the logo left-aligned */
.header-left {
    display: flex;
    align-items: center;
}

/* Keep the refresh button right-aligned */
.header-right {
    position: absolute;
    top: 10px;
    right: 10px;
}

#refresh-button {
    position: absolute;
    top: 2%;    
    right: 10px;    
    background-color: transparent;
    border: none;
    border-radius: 0;
    padding: 8px;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out, border-radius 0.2s ease-in-out;
}

#refresh-button:hover {
    background-color: #24354d;
    border-radius: 50%;
}
#refresh-button:active {
    transform: scale(0.9);
}

#refresh-button svg {
    width: 24px;
    height: 24px;
    fill: white;
}

        
        #logo {
    width: 100px; 
    height: auto; 
    margin-right: 10px;
    background: none;
    padding: 0; 
    border-radius: 0;
}


        #chat-title {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-white);
        }

        #chatbox {
    height: 60vh;  /* 60% of the viewport height */
    min-height: 300px;
    max-height: 600px;
    border-radius: 10px;
    overflow-y: auto;
    padding: 10px;
    background-color: #0d1b2a;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}

/* Adjustments for mobile devices */
@media (max-width: 600px) {
    #chat-container {
        width: 90%;
        padding: 10px;
    }
    #chatbox {
        height: 50vh;
        
    }
}
#chatbox::-webkit-scrollbar {
    width: 6px;
    border-radius: 10px; 
}

#chatbox::-webkit-scrollbar-track {
    background-color: #0d1b2a !important; 
    border-radius: 10px !important; 
}

#chatbox::-webkit-scrollbar-thumb {
    background: #6895a9 !important;
    border-radius: 10px !important; 
    min-height: 20px;
}

#chatbox::-webkit-scrollbar-corner {
    background: #0d1b2a !important;
}
        .user {
            color: #00c8ff;
            font-weight: bold;
        }

        .bot {
            color: #5aff15;
            font-weight: bold;
        }

        #input-area {
            display: flex;
            align-items: center;
            background-color: #0d1b2a;
            border-radius: 25px;
            padding: 10px;
            margin-top: 10px;
        }

        

        .visualization-img {
        display: block;
        width: 100%;
        max-height: 400px;    /* Limit height so it doesn't fill entire chat */
        border-radius: 8px;
        margin: 0 auto;
        }


        input {
            flex-grow: 1;
            border: none;
            background-color: transparent;
            color: #ffffff;
            padding: 10px;
            outline: none;
        }

       button {
    background-color: #6895a9;
    color: white;
    border: none;
    width: 45px; 
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    cursor: pointer;
    margin-left: 10px;
    font-size: 20px; 
    transition: background-color 0.2s ease-in-out;
    padding: 0; 
    line-height: 1; 
}

button:hover {
    background-color: #0095cc;
}

button:active {
    transform: scale(0.9); 
}
button:disabled {
  background-color: #ccc;  /* Shaded gray */
  cursor: not-allowed;
  opacity: 0.6;
  transition: background-color 0.2s ease-in-out;
}



        #file-upload {
            display: none;
        }
        .user-message, .bot-message {
    display: inline-block;
    background-color: #1E3A5F; 
    color: white;
    padding: 8px 12px;
    border-radius: 12px;
    max-width: 70%;
    word-wrap: break-word;
    white-space: normal;
    text-align: left;
    margin: 6px 5px; 
}

.bot-message {
    background-color: #14213d; 
    align-self: flex-start;
}

.user-message {
    align-self: flex-end;
}

.error-message {
    color: red;
    font-weight: bold;
    text-align: center; 
    display: flex;
    justify-content: center;
    width: 100%;
    margin-top: 10px;
}



        .upload-btn {
            background-color: #6895a9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 10px;
        }

        .upload-btn:hover {
            background-color: #0095cc;
        }
        .upload-btn.disabled {
        background-color: #ccc; /* Shaded gray */
        cursor: not-allowed;
        opacity: 0.6;
        pointer-events: none;  /* Prevent any clicks */
        transition: background-color 0.2s ease-in-out;
        }
        .upload-btn:active {
        transform: scale(0.9);
        }

        .upload-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
        }
                #intro-message {
                    text-align: center;
    color: rgb(194, 193, 193);
    font-size: 12px;
    margin-top: 50px;
    opacity: 0.7;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
        }
                #intro-message p {
            margin-bottom: 5px;
        }

        #intro-message p:last-child {
            margin-top: 10px; 
        }

/* Reuse your .bot-message styling, but add display:flex for the dots */
.bot-message.typing-indicator {
  display: inline-flex;         /* allow dots to appear in a row */
  background-color: #14213d;    /* same as your existing bot messages */
  color: #fff;
  padding: 8px 12px;
  border-radius: 12px;
  max-width: 70%;
  word-wrap: break-word;
  white-space: normal;
  text-align: left;
  margin: 6px 5px;
  align-self: flex-start;       /* appear on the left side like other bot msgs */
}

/* The animated dots */
.bot-message.typing-indicator .dot {
  background-color: #fff;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin: 0 2px;
  opacity: 0.2;
  animation: blink 1.4s infinite both;
}

/* Delay for the second and third dot to create the "moving" effect */
.bot-message.typing-indicator .dot:nth-child(2) {
  animation-delay: 0.2s;
}
.bot-message.typing-indicator .dot:nth-child(3) {
  animation-delay: 0.4s;
}

/* Keyframes for blinking dots */
@keyframes blink {
  0%   { opacity: 0.2; }
  20%  { opacity: 1;   }
  100% { opacity: 0.2; }
}
.download-wrapper {
  position: relative;
  display: inline-block; /* Needed so that the icon is positioned relative to the image */
  max-width: 90%;        /* Adjust as needed to make the image slightly smaller than the chatbox */
  margin: 10px auto;
  text-decoration: none; /* Remove underline */
}

.download-icon {
  position: absolute;
  bottom: 8px;
  right: 8px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: transparent;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 0.2s ease-in-out;
}

.download-icon:hover {
  background-color: lightgray; /* Light gray on hover */
}

.download-icon svg {
  width: 24px;
  height: 24px;
  fill: #1b263b;
}



    </style>
</head>
<body>

    <div id="chat-container">
        
        <!-- Refresh button at the top-right of the container -->
        <button id="refresh-button" class="header-btn" onclick="refreshPage()">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 .34-.03.67-.08 1h2.02c.05-.33.06-.66.06-1 0-4.42-3.58-8-8-8zm-6 7c0-.34.03-.67.08-1H4.06c-.05.33-.06.66-.06 1 0 4.42 3.58 8 8 8v3l4-4-4-4v3c-3.31 0-6-2.69-6-6z" fill="white"/>
            </svg>
        </button>

        <!-- HEADER -->
        <div id="chat-header">
            <!-- Left side: logo -->
            <div class="header-left">
                <img id="logo" src="visiobot logo.png" alt="VisioBot Logo">
            </div>
            <!-- ... any other header elements here ... -->
        </div>
        
        

        <div id="chatbox">
            <div id="intro-message">
                <p>Welcome to <strong>VisioBot</strong>! I can help you find the best data visualization for your dataset.</p>
                <p>Type <strong>"Hello"</strong> to get started!</p>
            </div>
            
        </div>
        
        <div id="input-area">
            <label for="file-upload" class="upload-btn">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 4L12 6H20C21.1 6 22 6.9 22 8V18C22 19.1 21.1 20 20 20H4C2.9 20 2 19.1 2 18V6C2 4.9 2.9 4 4 4H10Z" fill="white"/>
                </svg>
            </label>            
                        <input type="file" id="file-upload" accept=".csv">
                        <input type="text" id="userInput" placeholder="Ask anything...">
                        <button id="sendButton" onclick="sendMessage()" disabled>âž¤</button>
                        
        </div>
    </div>

    <script>
        let datasetUploaded = false;
        let datasetInfo = null;
        let purpose = "";
        let audience = "";
        let waitingForFeedback = false;
        let waitingForColumns = false;
        let waitingForRestart = false;
        let waitingForReuse = false;
        

    
        const chatbox = document.getElementById("chatbox");
    
        document.getElementById("userInput").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        });
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');

        userInput.addEventListener('input', function() {
        sendButton.disabled = this.value.trim() === '';
        });

        async function sendMessage() {
            let userInput = document.getElementById("userInput").value.trim();
            if (!userInput) return;
    
            chatbox.innerHTML += `<p class="user-message">${userInput}</p>`;
            document.getElementById("userInput").value = "";
            document.getElementById("sendButton").disabled = true;
            scrollToBottom();
    
            let lowerInput = userInput.toLowerCase();
            if (["hello", "hi", "hey"].includes(lowerInput)) {
                try {
                    let data = await fetchWithTyping("https://cautious-space-train-wrgx7wx5j7g6fv6xr-5000.app.github.dev/chat", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ message: userInput })
                    });
                    chatbox.innerHTML += `<p class="bot-message">${data.response}</p>`;
                    scrollToBottom();
                } catch (e) {
                    console.error("Greeting error:", e);
                }
                return;
            }

            if (waitingForReuse) {
                handleReuseFlow(userInput);
                return;
            }

            if (waitingForRestart) {
                handleRestartFlow(userInput);
                return;
            }
    
            if (waitingForColumns) {
                handleColumns(userInput);
                return;
            }
    
            if (waitingForFeedback) {
                handleFeedback(userInput);
                return;
            }
    
            if (!datasetUploaded) {
                if (!lowerInput.includes("upload")) {
                    callChatFallback(userInput);
                } else {
                    chatbox.innerHTML += `<p class="error-message">No dataset uploaded. Please use the upload button or type 'upload' to do so.</p>`;
                    scrollToBottom();
                }
                return;
            }
    
            if (!purpose) {
                purpose = userInput;
                chatbox.innerHTML += `<p class="bot-message">Who is your target audience? (Expert or Non-Expert)</p>`;
                scrollToBottom();
                return;
            }
    
            if (!audience) {
                audience = userInput;
                chatbox.innerHTML += `<p class="bot-message">Processing your data... Generating a visualization recommendation now.</p>`;
                scrollToBottom();
                requestVisualization(purpose, audience);
                return;
            }
    
            callChatFallback(userInput);
        }
    
        function callChatFallback(message) {
  addTypingIndicator();
  fetch("https://cautious-space-train-wrgx7wx5j7g6fv6xr-5000.app.github.dev/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message })
  })
  .then(r => r.json())
  .then(data => {
      removeTypingIndicator();
      chatbox.innerHTML += `<p class="bot-message">${data.response}</p>`;
      scrollToBottom();
  })
  .catch(e => {
      removeTypingIndicator();
      console.error("Chat fallback error:", e);
  });
}

    
        function scrollToBottom() {
            chatbox.scrollTop = chatbox.scrollHeight;
        }
        async function fetchWithTyping(url, options) {
            addTypingIndicator();
            try {
                let resp = await fetch(url, options);
                let data = await resp.json();
                // Optionally wait a short time to let the indicator show:
                await new Promise(resolve => setTimeout(resolve, 500));
                removeTypingIndicator();
                return data;
            } catch (e) {
                removeTypingIndicator();
                throw e;
            }
        }

        
    
        async function handleRestartFlow(userInput) {
            waitingForRestart = false;
            if (userInput.toLowerCase() === "yes") {
                try {
                    let data = await fetchWithTyping("https://cautious-space-train-wrgx7wx5j7g6fv6xr-5000.app.github.dev/restart", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" }
                    });
                    chatbox.innerHTML += `<p class="bot-message">${data.restart_message}</p>`;
                    scrollToBottom();
                    datasetUploaded = false;
                    datasetInfo = null;
                    purpose = "";
                    audience = "";
                    waitingForFeedback = false;
                    waitingForColumns = false;
                
                    document.querySelector('.upload-btn').classList.remove('disabled');
                    document.getElementById("file-upload").disabled = false;
                } catch (e) {
                    chatbox.innerHTML += `<p class="error-message">Error restarting: ${e}</p>`;
                    scrollToBottom();
                }
            } else if (userInput.toLowerCase() === "no") {
            chatbox.innerHTML += `
                <div id="intro-message">
                  <p>VisioBot has left the chat. Thank you for using our service!</p>
                </div>`;
            scrollToBottom();
            document.getElementById("input-area").style.display = "none";
        } else {
            chatbox.innerHTML += `<p class="error-message">Please respond with "Yes" or "No".</p>`;
            scrollToBottom();
            waitingForRestart = true;
        }
    }
    
    
        async function handleColumns(userInput) {
            waitingForColumns = false;
            try {
                let data = await fetchWithTyping("https://cautious-space-train-wrgx7wx5j7g6fv6xr-5000.app.github.dev/final-plot", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_request: userInput })
                });
    
                if (data.error) {
                    chatbox.innerHTML += `<p class="error-message">${data.error}</p>`;
                    scrollToBottom();
                } else {
                    chatbox.innerHTML += `<p class="bot-message">${data.message}</p>`;
                    scrollToBottom();

                    // If your backend returns a "plot_title" like "Map of population vs country", we build a safe filename:
const safeFilename = data.plot_title
  ? data.plot_title.replace(/\s+/g, '_').replace(/[^\w_]/g, '') + '.png'
  : 'visualization.png';

if (data.plot_url) {
  chatbox.innerHTML += `
    <span style="position: relative; display: inline-block; margin: 10px auto;">
      <img 
        class="visualization-img"
        src="${data.plot_url}"
        alt="${data.plot_title || 'Final Plot'}"
        style="width: 100%; max-height: 400px; border-radius: 8px; margin: 0 auto; display: block;"
        onload="scrollToBottom()"
        />

      <!-- Download button on bottom-right -->
      <button class="download-icon" title="Download Visualization" onclick="forceDownloadImage('${data.plot_url}', '${safeFilename}')">
  <svg viewBox="0 0 24 24">
    <path d="M19 9h-4V3H9v6H5l7 7 7-7z" />
    <path d="M5 18h14v2H5z" />
  </svg>
</button>


    </span>
  `;
  scrollToBottom();
}




                    
                    if (data.plot_description) {
                        chatbox.innerHTML += `<p class="bot-message">${data.plot_description}</p>`;
                        scrollToBottom();
                    }
                    if (data.ask_reuse) {
                        chatbox.innerHTML += `<p class="bot-message">${data.ask_reuse}</p>`;
                        scrollToBottom();
                        waitingForReuse = true;
                    }
                    else if (data.ask_restart) {
                        chatbox.innerHTML += `<p class="bot-message">${data.ask_restart}</p>`;
                        scrollToBottom();
                        waitingForRestart = true;
                    }
                }
            } catch (e) {
                chatbox.innerHTML += `<p class="error-message">Error generating final plot: ${e}</p>`;
                scrollToBottom();
            }
        }
    
        async function handleFeedback(feedback) {
            waitingForFeedback = false;
            let chatbox = document.getElementById("chatbox");
            if (feedback.toLowerCase() === "yes") {
                chatbox.innerHTML += `<p class="bot-message">Great! Proceeding with the selected visualization.</p>`;
                scrollToBottom();
                try {
                    let data = await fetchWithTyping("https://cautious-space-train-wrgx7wx5j7g6fv6xr-5000.app.github.dev/next-visualization", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ feedback: "yes" })
                    });
                    displayVisualization(data);
                } catch (e) {
                    chatbox.innerHTML += `<p class="error-message">Error fetching final step: ${e}</p>`;
                    scrollToBottom();
                }
            } else if (feedback.toLowerCase() === "no") {
                try {
                    let data = await fetchWithTyping("https://cautious-space-train-wrgx7wx5j7g6fv6xr-5000.app.github.dev/next-visualization", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ feedback: "no" })
                    });
                    displayVisualization(data);
                } catch (e) {
                    chatbox.innerHTML += `<p class="error-message">Error fetching next visualization: ${e}</p>`;
                    scrollToBottom();
                }
            } else {
                chatbox.innerHTML += `<p class="error-message">Please respond with "Yes" or "No".</p>`;
                scrollToBottom();
                waitingForFeedback = true;
            }
        }

        async function handleReuseFlow(userInput) {
    waitingForReuse = false;
    if (userInput.toLowerCase() === "yes") {
        try {
            let data = await fetchWithTyping("https://cautious-space-train-wrgx7wx5j7g6fv6xr-5000.app.github.dev/reuse-dataset", {
                method: "POST",
                headers: { "Content-Type": "application/json" }
            });
            // Depending on your get_dataset_columns endpoint response,
            // you might have data.final_message or data.message containing the columns prompt.
            chatbox.innerHTML += `<p class="bot-message">${data.final_message || data.message || "Please select the columns you want to visualize."}</p>`;
            scrollToBottom();
            waitingForColumns = true;
        } catch (e) {
            chatbox.innerHTML += `<p class="error-message">Error reusing dataset: ${e}</p>`;
            scrollToBottom();
        }
    } else if (userInput.toLowerCase() === "no") {
        // If the user does not want to reuse, then ask if they want to restart with a new dataset.
        chatbox.innerHTML += `<p class="bot-message">Would you like to start over with a new dataset? (Yes/No)</p>`;
        scrollToBottom();
        waitingForRestart = true;
    } else {
        chatbox.innerHTML += `<p class="error-message">Please respond with "Yes" or "No".</p>`;
        scrollToBottom();
        waitingForReuse = true;
    }
    scrollToBottom();

}
    
        function displayVisualization(data) {
            let chatbox = document.getElementById("chatbox");
            waitingForFeedback = false;
    
            if (data.pre_message) {
                chatbox.innerHTML += `<p class="bot-message">${data.pre_message}</p>`;
                scrollToBottom();
            }
            if (data.message && !data.prediction) {
                chatbox.innerHTML += `<p class="bot-message">${data.message}</p>`;
                scrollToBottom();
            }
            if (data.ask_reuse) {
                chatbox.innerHTML += `<p class="bot-message">${data.ask_reuse}</p>`;
                scrollToBottom();
                waitingForReuse = true;
                return;
            }
            if (data.ask_restart) {
                chatbox.innerHTML += `<p class="bot-message">${data.ask_restart}</p>`;
                scrollToBottom();
                waitingForRestart = true;
                return;
            }
            if (data.final_message) {
                chatbox.innerHTML += `<p class="bot-message">${data.final_message}</p>`;
                waitingForColumns = true;
                scrollToBottom();
            }
            if (data.prediction) {
                chatbox.innerHTML += `<p class="bot-message">Recommended Visualization: <strong>${data.prediction}</strong></p>`;
                scrollToBottom();
            }
            if (data.explanation) {
                chatbox.innerHTML += `<p class="bot-message">${data.explanation}</p>`;
                scrollToBottom();
            }
            if (data.note) {
                chatbox.innerHTML += `<p class="bot-message">${data.note}</p>`;
                scrollToBottom();
            }
            // If your backend returns a "plot_title" like "Map of population vs country", we build a safe filename:
const safeFilename = data.plot_title
  ? data.plot_title.replace(/\s+/g, '_').replace(/[^\w_]/g, '') + '.png'
  : 'visualization.png';

if (data.plot_url) {
  chatbox.innerHTML += `
    <span style="position: relative; display: inline-block; margin: 10px auto;">
      <img 
        class="visualization-img"
        src="${data.plot_url}"
        alt="${data.plot_title || 'Final Plot'}"
        style="width: 100%; max-height: 400px; border-radius: 8px; margin: 0 auto; display: block;"
        onload="scrollToBottom()"
        />

      <!-- Download button on bottom-right -->
      <button class="download-icon" title="Download Visualization" onclick="forceDownloadImage('${data.plot_url}', '${safeFilename}')">
  <svg viewBox="0 0 24 24">
    <path d="M19 9h-4V3H9v6H5l7 7 7-7z" />
    <path d="M5 18h14v2H5z" />
  </svg>
</button>


    </span>
  `;
  scrollToBottom();
}




            if (data.ask_feedback) {
                chatbox.innerHTML += `<p class="bot-message">${data.ask_feedback}</p>`;
                scrollToBottom();
                waitingForFeedback = true;
            }
        }
    
        async function requestVisualization(purpose, audience) {
            let requestData = {
                "Task (Purpose)": purpose,
                "Target Audience": audience
            };
            try {
                let data = await fetchWithTyping("https://cautious-space-train-wrgx7wx5j7g6fv6xr-5000.app.github.dev/get-visualization", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestData)
                });
                displayVisualization(data);
            } catch (e) {
                chatbox.innerHTML += `<p class="error-message">Error fetching visualization: ${e}</p>`;
            }
        }
        document.getElementById("file-upload").addEventListener("change", async function() {
        let file = this.files[0];
        if (!file) return;
        chatbox.innerHTML += `<p class="user-message">Sending... ${file.name}</p>`;
        scrollToBottom();

        let formData = new FormData();
        formData.append("file", file);

        try {
            let data = await fetchWithTyping("https://cautious-space-train-wrgx7wx5j7g6fv6xr-5000.app.github.dev/process-dataset", {
            method: "POST",
            body: formData,
            credentials: "include"
            });
            datasetUploaded = true;
            datasetInfo = data.dataset_details;
            chatbox.innerHTML += `<p class="bot-message">Dataset uploaded successfully!</p>`;
            scrollToBottom();
            chatbox.innerHTML += `<p class="bot-message">What is the purpose of your visualization? (Distribution, Relationship, Comparison, Trends)</p>`;
            scrollToBottom();

            // Disable file upload button and input
            document.querySelector('.upload-btn').classList.add('disabled');
            document.getElementById("file-upload").disabled = true;
        } catch (error) {
            chatbox.innerHTML += `<p class="error-message">Error: Dataset upload failed!</p>`;
            scrollToBottom();
            console.error("Upload error:", error);
        }
        });

        
        function refreshPage() {
            window.location.reload();
        }
        function addTypingIndicator() {
  // Remove any existing indicator first
  removeTypingIndicator();

  // Create a <p> with both "bot-message" and "typing-indicator" classes
  let indicator = document.createElement("p");
  indicator.className = "bot-message typing-indicator";
  indicator.id = "typingIndicator";

  // Insert three dots inside
  indicator.innerHTML = `
    <span class="dot"></span>
    <span class="dot"></span>
    <span class="dot"></span>
  `;

  // Append to the chatbox
  chatbox.appendChild(indicator);
  scrollToBottom();
}

function removeTypingIndicator() {
  let existing = document.getElementById("typingIndicator");
  if (existing) {
    existing.remove();
  }
}

async function forceDownloadImage(url, filename) {
  try {
    const resp = await fetch(url, { mode: "cors" });
    // If the response is opaque, you'll see a warning in the console.
    const blob = await resp.blob();

    // Create a temporary object URL for the blob.
    const objectURL = URL.createObjectURL(blob);

    // Create a hidden link element.
    const link = document.createElement("a");
    link.href = objectURL;
    link.download = filename || "visualization.png";

    // Append the link to the body.
    document.body.appendChild(link);

    // Programmatically click the link to trigger the download.
    link.click();

    // Remove the link and revoke the object URL.
    document.body.removeChild(link);
    URL.revokeObjectURL(objectURL);
  } catch (err) {
    console.error("Download failed:", err);
  }
}



    </script>
    
    
    
</body>
</html>